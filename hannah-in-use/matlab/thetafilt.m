function y = thetafilt(x)

% filters in theta frequency range 6-10. import eeg data from gh_debuffer.
% then hilbert transforms data and returns transformation
% example: 
% data = thetafilt(lfp.data);


persistent Hd;

if isempty(Hd)
    
    % The following code was used to design the filter coefficients:
    % % FIR Window Bandpass filter designed using the FIR1 function.
    %
    % % All frequency values are in Hz.
    % Fs = 2000;  % Sampling Frequency
    %
    % N    = 500;      % Order
    % Fc1  = 6;        % First Cutoff Frequency
    % Fc2  = 10;       % Second Cutoff Frequency
    % flag = 'scale';  % Sampling Flag
    % % Create the window vector for the design algorithm.
    % win = blackman(N+1);
    %
    % % Calculate the coefficients using the FIR1 function.
    % b  = fir1(N, [Fc1 Fc2]/(Fs/2), 'bandpass', win, flag);
    
    Hd = dsp.FIRFilter( ...
        'Numerator', [0 9.01368143995459e-08 3.61698506155789e-07 ...
        8.15977294586078e-07 1.45367661747709e-06 2.27489946083228e-06 ...
        3.2791365563217e-06 4.4652544584047e-06 5.8314835178779e-06 ...
        7.37540577342521e-06 9.09394278764052e-06 1.09833434588806e-05 ...
        1.30391718452053e-05 1.52562950415447e-05 1.7628871156034e-05 ...
        2.01503374362368e-05 2.28133986006086e-05 2.56100154351075e-05 ...
        2.85313937192554e-05 3.15679735501799e-05 3.47094191372272e-05 ...
        3.7944609143563e-05 4.12616276548037e-05 4.46477558580624e-05 ...
        4.80894645178951e-05 5.15724073384233e-05 5.50814153033883e-05 ...
        5.86004920880624e-05 6.21128106387394e-05 6.56007110169863e-05 ...
        6.90456996069061e-05 7.24284497843411e-05 7.5728804147226e-05 ...
        7.89257784061659e-05 8.1997567033741e-05 8.49215507700567e-05 ...
        8.7674306080606e-05 9.02316166606364e-05 9.25684870778656e-05 ...
        9.46591586426091e-05 9.64771275911237e-05 9.79951656642755e-05 ...
        9.91853431594789e-05 0.000100019054529244 0.000100467046594629 ...
        0.000100499449436372 0.00010008581002061 9.91951286096821e-05 ...
        9.77958980018317e-05 9.5856145636432e-05 9.3343478593858e-05 ...
        9.02251315112379e-05 8.64680174270759e-05 8.20387815591908e-05 ...
        7.69038580115431e-05 7.10295293963783e-05 6.43819893487094e-05 ...
        5.6927407900517e-05 4.86319996722018e-05 3.94620948287851e-05 ...
        2.93842127381795e-05 1.83651382585404e-05 6.37200057130336e-06 ...
        -6.6276455339352e-06 -2.06657360270434e-05 -3.57736117723165e-05 ...
        -5.19819305560609e-05 -6.93205771424779e-05 -8.78185715037958e-05 ...
        -0.000107503975380752 -0.000128403797339497 -0.000150543896500758 ...
        -0.00017394888512663 -0.000198642030259605 -0.000224645154617396 ...
        -0.00025197853695572 -0.000280660812119404 -0.000310708871010017 ...
        -0.000342137760705581 -0.000374960584974827 -0.000409188405434867 ...
        -0.000444830143606978 -0.000481892484130557 -0.000520379779399975 ...
        -0.000560293955893177 -0.000601634422464355 -0.000644397980875793 ...
        -0.000688578738846136 -0.000734168025893739 -0.000781154312254446 ...
        -0.000829523131153127 -0.000879257004707498 -0.00093033537374121 ...
        -0.000982734531780835 -0.00103642756350833 -0.00109138428793658 ...
        -0.00114757120657099 -0.0012049514568146 -0.00126348477086791 ...
        -0.00132312744036743 -0.00138383228699938 -0.00144554863931593 ...
        -0.00150822231597232 -0.00157179561559276 -0.00163620731346229 ...
        -0.00170139266522986 -0.00176728341779594 -0.00183380782754435 ...
        -0.00190089068606484 -0.00196845335349823 -0.0020364137996209 ...
        -0.00210468665277017 -0.00217318325669564 -0.00224181173540498 ...
        -0.00231047706605575 -0.00237908115992679 -0.00244752295148522 ...
        -0.00251569849554619 -0.00258350107250421 -0.00265082130159575 ...
        -0.00271754726213328 -0.00278356462263205 -0.00284875677773062 ...
        -0.00291300499278702 -0.00297618855601229 -0.00303818493798355 ...
        -0.0030988699583589 -0.00315811795959701 -0.00321580198746447 ...
        -0.00327179397809502 -0.00332596495134544 -0.00337818521017429 ...
        -0.0034283245457513 -0.00347625244798704 -0.00352183832115527 ...
        -0.00356495170426292 -0.00360546249580651 -0.00364324118253781 ...
        -0.00367815907184602 -0.00371008852734976 -0.0037389032072777 ...
        -0.00376447830520414 -0.00378669079269325 -0.00380541966339455 ...
        -0.00382054617812164 -0.00383195411043672 -0.00383952999225487 ...
        -0.0038431633589745 -0.00384274699363387 -0.0038381771695882 ...
        -0.00382935389119738 -0.00381618113201125 -0.00379856706993716 ...
        -0.0037764243188735 -0.00374967015629333 -0.00371822674626341 ...
        -0.00368202135738651 -0.00364098657515881 -0.00359506050823895 ...
        -0.00354418698813165 -0.00348831576179597 -0.00342740267669708 ...
        -0.00336140985782988 -0.00329030587625401 -0.00321406590869149 ...
        -0.00313267188775194 -0.0030461126423641 -0.00295438402800834 ...
        -0.00285748904636088 -0.00275543795397846 -0.00264824835967028 ...
        -0.00253594531022406 -0.00241856136417317 -0.00229613665331338 ...
        -0.00216871893169996 -0.00203636361187903 -0.00189913378813067 ...
        -0.00175710024652618 -0.00161034146162675 -0.00145894357967701 ...
        -0.00130300038817303 -0.00114261327171143 -0.000977891154053561 ...
        -0.000808950426366444 -0.000635914861630283 -0.000458915515230585 ...
        -0.000278090611781648 -9.35854182565542e-05 9.44478964721279e-05 ...
        0.000285850415548295 0.000480456641343364 0.000678094675772487 ...
        0.00087858641349754 0.00108174774777046 0.00128738878864271 ...
        0.0014953140932393 0.00170532290776878 0.00191720942091451 ...
        0.00213076302822628 0.00234576860710659 0.00256200680196122 ...
        0.00277925431906016 0.00299728423063202 0.00321586628769315 ...
        0.00343476724109173 0.00365375117022681 0.00387257981888374 ...
        0.00409101293760887 0.00430880863203049 0.00452572371651649 ...
        0.00474151407254569 0.004955935011156 0.00516874163882137 ...
        0.00537968922609852 0.00558853357837569 0.00579503140804762 ...
        0.00599894070743509 0.00620002112176176 0.00639803432149849 ...
        0.00659274437338245 0.00678391810941848 0.00697132549317075 ...
        0.00715473998265527 0.00733393888914787 0.00750870373122736 ...
        0.00767882058338067 0.00784408041850504 0.00800427944365186 ...
        0.00815921942836828 0.00830870802500489 0.0084525590803721 ...
        0.00859059293814277 0.00872263673141556 0.00884852466487121 ...
        0.00896809828597312 0.00908120674468393 0.00918770704119156 ...
        0.00928746426116026 0.0093803517980466 0.00946625156204461 ...
        0.00954505417524992 0.00961665915265981 0.00968097506865298 ...
        0.00973791970862145 0.00978742020545582 0.00982941316061486 ...
        0.00986384474954038 0.00989067081120948 0.00990985692164715 ...
        0.00992137845125403 0.00992522060583591 0.00992137845125403 ...
        0.00990985692164715 0.00989067081120948 0.00986384474954038 ...
        0.00982941316061486 0.00978742020545582 0.00973791970862145 ...
        0.00968097506865298 0.00961665915265981 0.00954505417524992 ...
        0.00946625156204461 0.0093803517980466 0.00928746426116026 ...
        0.00918770704119156 0.00908120674468393 0.00896809828597312 ...
        0.00884852466487121 0.00872263673141556 0.00859059293814277 ...
        0.0084525590803721 0.00830870802500489 0.00815921942836828 ...
        0.00800427944365186 0.00784408041850504 0.00767882058338067 ...
        0.00750870373122736 0.00733393888914787 0.00715473998265527 ...
        0.00697132549317075 0.00678391810941848 0.00659274437338245 ...
        0.00639803432149849 0.00620002112176176 0.00599894070743509 ...
        0.00579503140804762 0.00558853357837569 0.00537968922609852 ...
        0.00516874163882137 0.004955935011156 0.00474151407254569 ...
        0.00452572371651649 0.00430880863203049 0.00409101293760887 ...
        0.00387257981888374 0.00365375117022681 0.00343476724109173 ...
        0.00321586628769315 0.00299728423063202 0.00277925431906016 ...
        0.00256200680196122 0.00234576860710659 0.00213076302822628 ...
        0.00191720942091451 0.00170532290776878 0.0014953140932393 ...
        0.00128738878864271 0.00108174774777046 0.00087858641349754 ...
        0.000678094675772487 0.000480456641343364 0.000285850415548295 ...
        9.44478964721279e-05 -9.35854182565542e-05 -0.000278090611781648 ...
        -0.000458915515230585 -0.000635914861630283 -0.000808950426366444 ...
        -0.000977891154053561 -0.00114261327171143 -0.00130300038817303 ...
        -0.00145894357967701 -0.00161034146162675 -0.00175710024652618 ...
        -0.00189913378813067 -0.00203636361187903 -0.00216871893169996 ...
        -0.00229613665331338 -0.00241856136417317 -0.00253594531022406 ...
        -0.00264824835967028 -0.00275543795397846 -0.00285748904636088 ...
        -0.00295438402800834 -0.0030461126423641 -0.00313267188775194 ...
        -0.00321406590869149 -0.00329030587625401 -0.00336140985782988 ...
        -0.00342740267669708 -0.00348831576179597 -0.00354418698813165 ...
        -0.00359506050823895 -0.00364098657515881 -0.00368202135738651 ...
        -0.00371822674626341 -0.00374967015629333 -0.0037764243188735 ...
        -0.00379856706993716 -0.00381618113201125 -0.00382935389119738 ...
        -0.0038381771695882 -0.00384274699363387 -0.0038431633589745 ...
        -0.00383952999225487 -0.00383195411043672 -0.00382054617812164 ...
        -0.00380541966339455 -0.00378669079269325 -0.00376447830520414 ...
        -0.0037389032072777 -0.00371008852734976 -0.00367815907184602 ...
        -0.00364324118253781 -0.00360546249580651 -0.00356495170426292 ...
        -0.00352183832115527 -0.00347625244798704 -0.0034283245457513 ...
        -0.00337818521017429 -0.00332596495134544 -0.00327179397809502 ...
        -0.00321580198746447 -0.00315811795959701 -0.0030988699583589 ...
        -0.00303818493798355 -0.00297618855601229 -0.00291300499278702 ...
        -0.00284875677773062 -0.00278356462263205 -0.00271754726213328 ...
        -0.00265082130159575 -0.00258350107250421 -0.00251569849554619 ...
        -0.00244752295148522 -0.00237908115992679 -0.00231047706605575 ...
        -0.00224181173540498 -0.00217318325669564 -0.00210468665277017 ...
        -0.0020364137996209 -0.00196845335349823 -0.00190089068606484 ...
        -0.00183380782754435 -0.00176728341779594 -0.00170139266522986 ...
        -0.00163620731346229 -0.00157179561559276 -0.00150822231597232 ...
        -0.00144554863931593 -0.00138383228699938 -0.00132312744036743 ...
        -0.00126348477086791 -0.0012049514568146 -0.00114757120657099 ...
        -0.00109138428793658 -0.00103642756350833 -0.000982734531780835 ...
        -0.00093033537374121 -0.000879257004707498 -0.000829523131153127 ...
        -0.000781154312254446 -0.000734168025893739 -0.000688578738846136 ...
        -0.000644397980875793 -0.000601634422464355 -0.000560293955893177 ...
        -0.000520379779399975 -0.000481892484130557 -0.000444830143606978 ...
        -0.000409188405434867 -0.000374960584974827 -0.000342137760705581 ...
        -0.000310708871010017 -0.000280660812119404 -0.00025197853695572 ...
        -0.000224645154617396 -0.000198642030259605 -0.00017394888512663 ...
        -0.000150543896500758 -0.000128403797339497 -0.000107503975380752 ...
        -8.78185715037958e-05 -6.93205771424779e-05 -5.19819305560609e-05 ...
        -3.57736117723165e-05 -2.06657360270434e-05 -6.6276455339352e-06 ...
        6.37200057130336e-06 1.83651382585404e-05 2.93842127381795e-05 ...
        3.94620948287851e-05 4.86319996722018e-05 5.6927407900517e-05 ...
        6.43819893487094e-05 7.10295293963783e-05 7.69038580115431e-05 ...
        8.20387815591908e-05 8.64680174270759e-05 9.02251315112379e-05 ...
        9.3343478593858e-05 9.5856145636432e-05 9.77958980018317e-05 ...
        9.91951286096821e-05 0.00010008581002061 0.000100499449436372 ...
        0.000100467046594629 0.000100019054529244 9.91853431594789e-05 ...
        9.79951656642755e-05 9.64771275911237e-05 9.46591586426091e-05 ...
        9.25684870778656e-05 9.02316166606364e-05 8.7674306080606e-05 ...
        8.49215507700567e-05 8.1997567033741e-05 7.89257784061659e-05 ...
        7.5728804147226e-05 7.24284497843411e-05 6.90456996069061e-05 ...
        6.56007110169863e-05 6.21128106387394e-05 5.86004920880624e-05 ...
        5.50814153033883e-05 5.15724073384233e-05 4.80894645178951e-05 ...
        4.46477558580624e-05 4.12616276548037e-05 3.7944609143563e-05 ...
        3.47094191372272e-05 3.15679735501799e-05 2.85313937192554e-05 ...
        2.56100154351075e-05 2.28133986006086e-05 2.01503374362368e-05 ...
        1.7628871156034e-05 1.52562950415447e-05 1.30391718452053e-05 ...
        1.09833434588806e-05 9.09394278764052e-06 7.37540577342521e-06 ...
        5.8314835178779e-06 4.4652544584047e-06 3.2791365563217e-06 ...
        2.27489946083228e-06 1.45367661747709e-06 8.15977294586078e-07 ...
        3.61698506155789e-07 9.01368143995459e-08 0]);
end

d = step(Hd,x);
y = abs(hilbert(d));

